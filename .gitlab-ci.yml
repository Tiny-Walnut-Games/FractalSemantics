stages:
  - quality
  - validate
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSION: "3.11"

cache:
  paths:
    - .cache/pip
    - venv/

before_script:
  - pip install --upgrade pip setuptools wheel

## ============================================================================
## QUALITY STAGE - Code Quality Checks
## ============================================================================

code_format:
  stage: quality
  image: python:${PYTHON_VERSION}
  script:
    - pip install black[d]
    - black --check fractalstat/
  allow_failure: false
  only:
    - merge_requests
    - main

lint:
  stage: quality
  image: python:${PYTHON_VERSION}
  script:
    - pip install ruff
    - ruff check fractalstat/
  allow_failure: false
  only:
    - merge_requests
    - main

type_check:
  stage: quality
  image: python:${PYTHON_VERSION}
  script:
    - pip install mypy types-click types-requests
    - mypy fractalstat/ --ignore-missing-imports
  allow_failure: true
  only:
    - merge_requests
    - main

## ============================================================================
## VALIDATE STAGE - Experiment-Based Validation
## ============================================================================

validate_experiments:
  tags:
    - saas-linux-medium-amd64
  stage: validate
  image: python:${PYTHON_VERSION}
  variables:
    FRACTALSTAT_ENV: "ci"
  script:
    - pip install -e .
    - python -m fractalstat.stat7_experiments
    - python -m fractalstat.exp04_fractal_scaling
    - python -m fractalstat.exp05_compression_expansion
    - python -m fractalstat.exp06_entanglement_detection
    - python -m fractalstat.exp07_luca_bootstrap
    - python -m fractalstat.exp08_llm_integration
    - python -m fractalstat.exp09_concurrency
    - python -m fractalstat.exp11_dimension_cardinality
    - python -m fractalstat.exp12_benchmark_comparison
  artifacts:
    paths:
      - experiment_reports/
      - .coverage
      - "exp*.json"
      - "bob_stress_test*.json"
      - fractalstat/config/experiments.toml
      - fractalstat/config/experiments.ci.toml
    expire_in: 30 days
    when: always
  timeout: 2 hours
  retry:
    max: 1
    when: runner_system_failure
  only:
    - merge_requests
    - main

stress_tests:
  tags:
    - saas-linux-large-amd64
  stage: validate
  image: python:${PYTHON_VERSION}
  script:
    - pip install -e .
    - python -m fractalstat.bob_stress_test
  artifacts:
    paths:
      - stress_test_results/
    expire_in: 30 days
    when: always
  timeout: 1 hour
  allow_failure: true
  only:
    - manual
    - main

## ============================================================================
## BUILD STAGE - Package Creation
## ============================================================================

build_package:
  stage: build
  image: python:${PYTHON_VERSION}
  script:
    - pip install build wheel
    - python -m build
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - tags
    - main

# Publication automation - runs on tags
publication_archive:
  stage: build
  image: python:${PYTHON_VERSION}
  dependencies: []
  script:
    - pip install -e .
    - python scripts/generate_doi_metadata.py ${CI_COMMIT_TAG#v}
    - python scripts/create_publication_archive.py ${CI_COMMIT_TAG#v}
  artifacts:
    paths:
      - publication/
    expire_in: never
  only:
    - tags
  when: on_success

## ============================================================================
## DEPLOY STAGE - Package Distribution
## ============================================================================

deploy_pypi:
  stage: deploy
  image: python:${PYTHON_VERSION}
  dependencies:
    - build_package
  script:
    - pip install twine
    - twine upload dist/* --non-interactive --skip-existing
  environment:
    name: pypi
    url: https://pypi.org/project/fractalstat/
  only:
    - tags
  when: manual

deploy_huggingface:
  stage: deploy
  image: python:${PYTHON_VERSION}
  dependencies:
    - build_package
  script:
    - pip install huggingface-hub wheel
    - python -c "from huggingface_hub import HfApi; HfApi().upload_folder(repo_id='${HF_REPO_ID}', folder_path='dist/', repo_type='model', token='${HF_TOKEN}')"
  environment:
    name: huggingface
    url: https://huggingface.co/${HF_REPO_ID}
  only:
    - tags
  when: manual

deploy_api_dev:
  stage: deploy
  image: python:${PYTHON_VERSION}
  environment:
    name: development
    url: https://api-dev.example.com
  script:
    - pip install -e .
  only:
    - develop
  when: manual

deploy_api_prod:
  stage: deploy
  image: python:${PYTHON_VERSION}
  environment:
    name: production
    url: https://api.example.com
  script:
    - pip install -e .
  only:
    - main
  when: manual
